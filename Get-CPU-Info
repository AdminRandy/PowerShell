param (
    [Parameter(Mandatory = $true, Position = 0)]
    [Alias("etsn")]
    [string]$Server
)

function Get-SystemStatus {
    if (Test-Connection -ComputerName $Server -Quiet) {
        $systemInfo = Invoke-Command -ComputerName $Server -ScriptBlock {
            $system = Get-WmiObject Win32_OperatingSystem
            $cpuUsage = (Get-WmiObject Win32_Processor | Measure-Object -Property LoadPercentage -Average).Average
            $memInfo = Get-WmiObject Win32_OperatingSystem | Select-Object TotalVisibleMemorySize, FreePhysicalMemory, TotalVirtualMemorySize, FreeVirtualMemory, PagingFiles
            $memUsage = ($memInfo.TotalVisibleMemorySize - $memInfo.FreePhysicalMemory) / $memInfo.TotalVisibleMemorySize * 100
            $availableMemoryMB = $memInfo.FreePhysicalMemory / 1MB

            $pageFileInUse = if ($memInfo.PagingFiles) {
                $memInfo.PagingFiles[0]
            } else {
                "N/A"
            }

            [PSCustomObject]@{
                "DateTime" = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                "CPU" = "{0:N2}" -f $cpuUsage
                "MEM" = "{0:N2}" -f $memUsage
                "Avail" = "{0:N0}" -f $availableMemoryMB
                "PAGE" = $pageFileInUse
            }
        }

        $systemInfoStr = "$($systemInfo.DateTime) > CPU: $($systemInfo.CPU) %, MEM: $($systemInfo.MEM) % (Avail: $($systemInfo.Avail) MB), PAGE: $($systemInfo.PAGE)"
        Write-Host $systemInfoStr -ForegroundColor Red
    } else {
        Write-Host "Unable to connect to the server: $Server" -ForegroundColor Red
    }
}

function Get-HighestCPUService {
    if (Test-Connection -ComputerName $Server -Quiet) {
        $highestCPUProcess = Invoke-Command -ComputerName $Server -ScriptBlock {
            Get-Process | Where-Object { $_.CPU -gt 0 } | Sort-Object -Descending CPU | Select-Object -First 1
        }

        if ($highestCPUProcess) {
            $serviceName = Get-WmiObject -Class Win32_Service -Filter "ProcessId = $($highestCPUProcess.Id)" -ComputerName $Server | Select-Object -ExpandProperty Name
            $highestCPUServiceStr = "Highest CPU Service: $($highestCPUProcess.Name) (Service: $serviceName)"
            Write-Host $highestCPUServiceStr -ForegroundColor Green
        } else {
            Write-Host "No running processes with CPU usage found on $Server" -ForegroundColor Red
        }
    } else {
        Write-Host "Unable to connect to the server: $Server" -ForegroundColor Red
    }
}

function Get-HighestMemoryService {
    if (Test-Connection -ComputerName $Server -Quiet) {
        $highestMemoryProcess = Invoke-Command -ComputerName $Server -ScriptBlock {
            Get-Process | Where-Object { $_.WS -gt 0 } | Sort-Object -Descending WS | Select-Object -First 1
        }

        if ($highestMemoryProcess) {
            $serviceName = Get-WmiObject -Class Win32_Service -Filter "ProcessId = $($highestMemoryProcess.Id)" -ComputerName $Server | Select-Object -ExpandProperty Name
            $highestMemoryServiceStr = "Highest Memory Service: $($highestMemoryProcess.Name) (Service: $serviceName)"
            Write-Host $highestMemoryServiceStr -ForegroundColor Green
        } else {
            Write-Host "No running processes with memory usage found on $Server" -ForegroundColor Red
        }
    } else {
        Write-Host "Unable to connect to the server: $Server" -ForegroundColor Red
    }
}

while ($true) {
    Get-SystemStatus
    Get-HighestCPUService
    Get-HighestMemoryService
    Start-Sleep -Seconds 2
}
